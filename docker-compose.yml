version: '3.8'

# ==========================================
# YPrompt Docker Compose 配置
# 适配 Traefik 反向代理
# 
# 使用前提：
# 1. 已有 Traefik 运行并创建了外部网络
# 2. 创建 .env 文件配置域名和密钥
#
# 快速启动：
# docker-compose up -d
# 
# 如果不使用 Traefik，请使用 docker-compose.standalone.yml
# ==========================================

services:
  yprompt:
    image: ${YPROMPT_IMAGE:-ghcr.io/fish2018/yprompt:latest}
    container_name: yprompt
    restart: unless-stopped
    
    volumes:
      - ./data:/app/data
    
    environment:
      # 后端配置
      - YPROMPT_PORT=8080
      - YPROMPT_HOST=0.0.0.0
      - YPROMPT_WORKERS=1
      
      # 数据库配置
      - DB_TYPE=sqlite
      - SQLITE_DB_PATH=/app/data/yprompt.db
      
      # JWT配置（生产环境请修改）
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      
      # Linux.do OAuth配置（可选）
      - LINUX_DO_CLIENT_ID=${LINUX_DO_CLIENT_ID:-}
      - LINUX_DO_CLIENT_SECRET=${LINUX_DO_CLIENT_SECRET:-}
      - LINUX_DO_REDIRECT_URI=${LINUX_DO_REDIRECT_URI:-}
      
      # 默认管理员账号
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
    
    labels:
      # Traefik 配置
      - "traefik.enable=true"
      
      # HTTP 路由
      - "traefik.http.routers.yprompt.rule=Host(`${DOMAIN:-yprompt.localhost}`)"
      - "traefik.http.routers.yprompt.entrypoints=web"
      
      # HTTPS 路由（如果启用）
      - "traefik.http.routers.yprompt-secure.rule=Host(`${DOMAIN:-yprompt.localhost}`)"
      - "traefik.http.routers.yprompt-secure.entrypoints=websecure"
      - "traefik.http.routers.yprompt-secure.tls=true"
      - "traefik.http.routers.yprompt-secure.tls.certresolver=${CERT_RESOLVER:-letsencrypt}"
      
      # 服务配置
      - "traefik.http.services.yprompt.loadbalancer.server.port=8080"
      
      # HTTP 重定向到 HTTPS（可选，取消注释启用）
      # - "traefik.http.routers.yprompt.middlewares=redirect-to-https"
      # - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
    
    networks:
      - traefik-network

networks:
  traefik-network:
    external: true
    name: ${TRAEFIK_NETWORK:-traefik-network}
